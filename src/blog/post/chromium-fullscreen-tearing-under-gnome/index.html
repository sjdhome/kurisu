<!DOCTYPE html>
<html lang="zh-Hans">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="GNOME桌面环境下Chromium系浏览器在全屏播放视频或动图时会出现横线闪烁，影响观感。" />
  <title>解决GNOME桌面环境下Chromium系浏览器全屏时有横线闪烁 - sjdhome blog</title>
  <link rel="stylesheet" href="/css/flex.css" />
  <link rel="stylesheet" href="/css/limit-content-width.css" />
  <link rel="stylesheet" href="/css/font.css" />
  <link rel="stylesheet" href="/css/global.css" />
  <link rel="stylesheet" href="/blog/css/block.css" />
  <link rel="stylesheet" href="/blog/css/title-block.css" />
  <link rel="stylesheet" href="/css/body.css" />
  <link rel="stylesheet" href="/css/copyright.css" />
  <link rel="stylesheet" href="/css/code.css" />
  <link rel="stylesheet" href="/css/better-hr.css" />
  <link rel="stylesheet" href="/blog/css/post.css" />
  <link rel="stylesheet" href="/css/margin.css" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
</head>

<body>
  <header>
    <div class="flex flex-vertical limit-content-width title-block">
      <div class="flex align-items-center margin-lr-1dot5">
        <a href="/blog/">
          <picture>
            <source srcset="/img/earth.webp">
            <source srcset="/img/earth.jpg">
            <img src="/img/earth.jpg" alt="avatar" width="64" height="64" class="round" />
          </picture>
        </a>
        <a href="/blog/" class="title-text no-a-decoration">sjdhome blog</a>
      </div>
      <div class="subtitle margin-lr-1dot5">
        <small>愿你有一天能与重要的人重逢</small>
      </div>
    </div>
  </header>
  <hr />
  <main class="limit-content-width flex">
    <div class="only-block-style">
      <h1 class="post-title">解决GNOME桌面环境下Chromium系浏览器全屏时有横线闪烁</h1>
      <small><time datetime="2023-08-09T02:51:00.000Z">2023年8月9日</time></small>
      <h2>大前提</h2>
      <p>本文假设你使用的是GNOME (Wayland)，且使用Xwayland运行Chromium系浏览器。</p>
      <h2>TL;DR</h2>
      <p>安装<a href="https://github.com/kazysmaster/gnome-shell-extension-disable-unredirect">gnome-shell-extension-disable-unredirect</a>这个GNOME插件并启用。如果从AUR安装可能需要自己改一下兼容GNOME版本号。</p>
      <h2>分析</h2>
      <p>经过了数年的努力，Linux桌面在Wayland的环境下，大部分软件都可以正常使用了。Chromium系浏览器虽然可以通过设定<code>--ozone-platform-hint=auto</code>来启用Native Wayland，但硬件加速就没法工作了，大概是因为我用的是NVIDIA卡的缘故。</p>
      <p>默认情况下，Chromium系浏览器都是运行在Xwayland下，且启用硬件加速。在播放YouTube或哔哩哔哩视频时，如果不全屏，视频可以正常播放。如果进入全屏模式，过几秒画面上就会出现闪烁的横线。</p>
      <p>互联网上的大部分教程都是让关闭硬件加速或者传入各种奇奇怪怪的Chromium flags。关闭硬件加速是治标不治本的行为，对于日常网页浏览影响不大，但是会显著增加CPU负担，尤其是播放4K视频的情况下。各种奇怪的flags，如<code>--ignore-gpu-blocklist</code>、<code>--use-gl=egl</code>以及Arch Linux Wiki上有关Chromium硬件加速的flags，还有VAAPI，测试下来基本没有效果，部分似乎有效果的flags都是误打误撞把硬件加速禁用了。</p>
      <p>经过众多搜索后，我意识到这似乎是一个垂直同步问题，虽然画面上是跳动的横线，不像Windows下的画面撕裂是错位的样子，但应该和垂直同步有关。于是我参考了<a href="https://www.reddit.com/r/archlinux/comments/126l5qp/how_do_i_enable_desktop_vsync_on_gnome_wayland/">How do I enable desktop Vsync on GNOME Wayland with NVIDIA driver?</a>，并尝试了<a href="https://github.com/kazysmaster/gnome-shell-extension-disable-unredirect">gnome-shell-extension-disable-unredirect</a>，这是一个GNOME扩展，问题解决了。</p>
      <p>我的猜测是GNOME在浏览器全屏后不再强制对窗口进行画面转发和同步，而是由窗口自己负责，进而导致浏览器出现画面撕裂。Chromium系浏览器在Linux下不会自行垂直同步的问题已经有很长时间了，但一直没有解决过。gnome-shell-extension-disable-unredirect仅仅是强制GNOME继续接管全屏窗口，并没有解决垂直同步问题。</p>
      <p>在搜索过程中还发现了<a href="https://aur.archlinux.org/packages/mutter-dynamic-buffering">mutter-dynamic-buffering</a>，这个包把GNOME混成器Mutter替换成开启双重或三重缓冲的版本，但这样对系统包的介入性过强，因此没有尝试。</p>
      <h2>我用的不是GNOME！</h2>
      <p>对于其他桌面环境，解决思路应该类似，都是打开自己的桌面混成器的垂直同步或三重缓冲功能。</p>
      <h2>遗留问题</h2>
      <p>虽然在<code>chrome://gpu</code>里显示<code>Hardware accelerated</code>，但播放视频时在F12控制台的Media选项卡里并没有看到调用显卡解码，依然是<code>FFmpegVideoDecoder</code>且Hardware Decoder为<code>false</code>。</p>
      <h2>参考资料</h2>
      <ul>
        <li><a href="https://github.com/kazysmaster/gnome-shell-extension-disable-unredirect">gnome-shell-extension-disable-unredirect</a></li>
        <li><a href="https://www.reddit.com/r/archlinux/comments/126l5qp/how_do_i_enable_desktop_vsync_on_gnome_wayland/">How do I enable desktop Vsync on GNOME Wayland with NVIDIA driver?</a></li>
        <li><a href="https://aur.archlinux.org/packages/mutter-dynamic-buffering">mutter-dynamic-buffering</a></li>
        <li><a href="https://wiki.archlinux.org/title/chromium">Chromium - Arch Linux Wiki</a></li>
      </ul>
    </div>
  </main>
  <footer>
    <div class="copyright">Copyright &copy; 2023 sjdhome</div>
  </footer>
</body>

</html>